<app-actionbar
  [showFilters]="true"
  (searchTextChange)="this.searchText = $event; this.searchTextChanged()"
  (mediaTypesChange)="this.mediaTypesSelected = $event; this.updateFilter()"
  (filterTypesChange)="this.filterTypesSelected = $event; this.updateFilter()"
  (showCompilationsChange)="this.showCompilations = $event; this.updateFilter()"
  (sortOrderChange)="this.sortOrder = $event; this.updateFilter()"
  [searchTextSuggestions]="searchTextSuggestions()"
/>

<section class="content">
  <div class="entity-grid" id="main">
    <div class="loading-overlay" [class.visible]="isWaitingForExploreResult()">
      <p>{{ 'Loading results. This can sometimes take a moment' | translate }}</p>
      <mat-spinner mode="indeterminate" />
    </div>

    @for (element of filteredResults; track element._id) {
      <div class="grid-item">
        <app-grid-element [element]="element" (updateSelectedObject)="selectObjectId = $event" />
        <mat-icon class="material-symbols-filled card-icon">deployed_code</mat-icon>
        <!-- Advanced settings -->
        <button class="actionbutton" mat-icon-button [matMenuTriggerFor]="menu" color="primary">
          <mat-icon>more_horiz</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <a mat-menu-item [routerLink]="['/entity', element._id]">
            <mat-icon class="material-symbols-outlined" color="primary">open_run</mat-icon>
            <span>{{ 'Open' | translate }}</span>
          </a>
          <button mat-menu-item [matMenuTriggerFor]="quickAddToCollectionMenu">
            <mat-icon color="primary">library_add</mat-icon>
            <span>{{ 'Add to collection' | translate }}</span>
          </button>
        </mat-menu>
      </div>
    }
  </div>

  <div class="paginator-container">
    <mat-paginator
      [length]="paginatorLength"
      [pageSize]="paginatorPageSize"
      [pageSizeOptions]="[30]"
      (page)="changePage($event)"
      [pageIndex]="paginatorPageIndex"
    />
  </div>
</section>

<mat-menu #quickAddToCollectionMenu="matMenu">
  @if (!(isAuthenticated$ | async)) {
    <div style="padding: 0 2rem">
      <p>{{ 'You have to login to create and modify collections.' | translate }}</p>
    </div>
  }
  @if (isAuthenticated$ | async) {
    <button mat-menu-item (click)="openCompilationWizard(selectObjectId)">
      <mat-icon color="primary">create_new_folder</mat-icon>
      <span>{{ 'New collection with this object' | translate }}</span>
    </button>
    @if (userCompilations$ | async; as userCompilations) {
      @if (userCompilations.length > 0) {
        @for (compilation of userCompilations; track compilation._id) {
          <button mat-menu-item (click)="quickAddToCompilation(compilation)">
            <mat-icon color="primary">collections</mat-icon>
            <span>{{ compilation.name }}</span>
          </button>
        }
      }
    }
  }
</mat-menu>
