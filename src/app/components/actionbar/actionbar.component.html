<mat-toolbar id="actionbar">
  @if (element(); as element) {
    <!-- Publishing option -->
    @if (isAuthenticated() && isEditingAllowed() && isEntity() && isDetailPage()) {
      <div>
        @if (isPublished()) {
          <button
            mat-flat-button
            color="primary"
            matTooltip="{{
              'This object is currently open to the public. Click to unpublish!' | translate
            }}"
            [disabled]="!(element | isUserOfRole: 'owner' : user())"
            (click)="togglePublished()"
          >
            <mat-icon>flip_to_back</mat-icon>
            {{ 'Unpublish' | translate }}
          </button>
        } @else {
          <button
            mat-flat-button
            color="primary"
            matTooltip="{{
              'This object is currently hidden from the public. Click to publish!' | translate
            }}"
            [disabled]="!(element | isUserOfRole: 'owner' : user())"
            (click)="togglePublished()"
          >
            <mat-icon>publish</mat-icon>
            {{ 'Publish!' | translate }}
          </button>
        }
      </div>
    }

    @if (isAnnotatePage()) {
      <!-- Switch to detail page -->
      <div>
        <button mat-flat-button color="primary" [routerLink]="detailPageLink()">
          <mat-icon>visibility</mat-icon>
          {{ isEntity() ? 'Show object' : ('Show collection' | translate) }}
        </button>
      </div>
    } @else if (isDetailPage()) {
      <!-- Switch to annotation page -->
      <div
        [matTooltip]="
          (isAnnotatingAllowed() ? '' : 'You are not allowed to annotate right now.') | translate
        "
      >
        <button
          mat-flat-button
          color="primary"
          [disabled]="!isAnnotatingAllowed() || !element"
          [routerLink]="annotateLink()"
        >
          <mat-icon>location_on</mat-icon>
          {{ 'Annotate' | translate }}
        </button>
      </div>
    }

    <!-- Edit Entity settings -->
    @if (isEntity() && isEditingAllowed()) {
      <div
        matTooltip="{{
          'Adjust the viewer settings, metadata or visibility of this object.' | translate
        }}"
      >
        <button
          mat-icon-button
          [disabled]="element | isUserOfRole: 'viewer' : user()"
          [matMenuTriggerFor]="editMenu"
        >
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    }
    <!-- Edit collection -->
    @if (isCompilation() && isEditingAllowed()) {
      <div matTooltip="{{ 'Edit this collection.' | translate }}">
        <button mat-icon-button (click)="editCompilation()">
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    }
    <!-- Edit permissions -->
    @if (!isEditingAllowed()) {
      <div
        matTooltip="{{
          'Only the object owner is able to edit settings of this object.' | translate
        }}"
      >
        <button mat-icon-button disabled>
          <mat-icon>edit</mat-icon>
        </button>
      </div>
    }
    <!-- Quick add entity to compilation -->
    @if (isAuthenticated() && isEntity()) {
      <div matTooltip="{{ 'Use this object in a collection' | translate }}">
        <button mat-icon-button [matMenuTriggerFor]="quickAddToCollectionMenu">
          <mat-icon>library_add</mat-icon>
        </button>
      </div>
    }

    <!-- Explore Collections with Object -->
    @if (showUsesInCollection()) {
      <div
        [matTooltip]="
          (selectHistory.usedInCompilations.compilations.length === 0
            ? 'This object is not used in any collection.'
            : 'Explore collections containing this object.'
          ) | translate
        "
      >
        <button
          [disabled]="selectHistory.usedInCompilations.compilations.length === 0"
          mat-icon-button
          [matMenuTriggerFor]="usedInCompilationsMenu"
        >
          <mat-icon>library_add_check</mat-icon>
        </button>
      </div>
    }

    <div>
      <button
        mat-icon-button
        matTooltip="{{ 'Embed this object on your web page' | translate }}"
        (click)="copyEmbed()"
      >
        <mat-icon>perm_media</mat-icon>
      </button>
    </div>
    @if (metadataDownload(); as metadataDownload) {
      <a
        [href]="metadataDownload.url"
        [download]="metadataDownload.title"
        style="color: inherit"
        class="no-prefix"
      >
        <button mat-icon-button matTooltip="{{ 'Download metadata' | translate }}">
          <mat-icon>list_alt</mat-icon>
        </button>
      </a>
    }
    <div>
      <button mat-icon-button matTooltip="{{ 'Copy ID' | translate }}" (click)="copyId()">
        <mat-icon>content_copy</mat-icon>
      </button>
    </div>

    <!-- Download model files -->
    @if (isEntity()) {
      @if (isDownloadable$ | observableValue | async; as isDownloadable) {
        <div
          [matTooltip]="
            (isDownloadable ? 'Download model files' : 'Download not available') | translate
          "
        >
          <button mat-icon-button (click)="openDownloadDialog()" [disabled]="!isDownloadable">
            <mat-icon>file_download</mat-icon>
          </button>
        </div>
      } @else {
        <div matTooltip="{{ ('Loading' | translate) + '... }}">
          <button mat-icon-button disabled>
            <mat-icon>file_download</mat-icon>
          </button>
        </div>
      }
    }
  }
</mat-toolbar>

<mat-menu #usedInCompilationsMenu="matMenu">
  @for (compilation of selectHistory.usedInCompilations.compilations; track compilation._id) {
    <button mat-menu-item (click)="navigate(compilation)">
      <mat-icon [matTooltip]="'View collection' | translate"> folder_special </mat-icon>
      @if (isRecentlyAnnotated(compilation)) {
        <mat-icon
          [matTooltip]="
            'The current object has been recently annotated in this collection' | translate
          "
          >access_time</mat-icon
        >
      }
      @if (isAnnotatedInCompilation(compilation)) {
        <mat-icon [matTooltip]="'The current object is annotated in this collection' | translate">
          label
        </mat-icon>
      }
      {{ compilation.name }}
    </button>
  }
</mat-menu>

<mat-menu #editMenu="matMenu">
  <!-- TODO: Maybe change viewer mode? -->
  @if (element(); as element) {
    <button mat-menu-item (click)="editSettingsInViewer()">
      {{ 'Viewer settings' | translate }}
    </button>
    <button mat-menu-item (click)="editMetadata()">{{ 'Metadata' | translate }}</button>
    <button
      mat-menu-item
      [disabled]="!(element | isUserOfRole: 'owner' : user())"
      (click)="editVisibility()"
    >
      {{ 'Visibility' | translate }}
    </button>
  }
</mat-menu>

<mat-menu #quickAddToCollectionMenu="matMenu" yPosition="above" xPosition="before">
  <button mat-menu-item (click)="openCompilationWizard()">
    <!-- <mat-icon color="primary">create_new_folder</mat-icon> -->
    <span>{{ 'New collection with this object' | translate }}</span>
  </button>
  @if (userCompilations$ | async; as userCompilations) {
    @if (userCompilations.length > 0) {
      <button mat-menu-item [matMenuTriggerFor]="showUserCompilation">
        <span>{{ 'Add to existing Collection' | translate }}</span>
      </button>
    }
  }
</mat-menu>

<mat-menu #showUserCompilation="matMenu" yPosition="below" xPosition="after">
  @if (userCompilations$ | async; as userCompilations) {
    @if (userCompilations.length > 0) {
      @for (compilation of userCompilations; track compilation._id) {
        <button mat-menu-item (click)="quickAddToCompilation(compilation)">
          {{ compilation.name }}
        </button>
      }
    }
  }
</mat-menu>

<!-- <mat-menu #quickAddToCollectionMenu="matMenu">
    <button mat-menu-item (click)="openCompilationWizard()">
      <mat-icon color="primary">create_new_folder</mat-icon>
      <span>{{ 'New collection with this object' | translate }}</span>
    </button>
    @if (userCompilations.length > 0) {
      @for (compilation of userCompilations; track compilation) {
        <button
          mat-menu-item
          (click)="quickAddToCompilation(compilation)"
          >
          {{ compilation.name }}
        </button>
      }
    }
  </mat-menu> -->
